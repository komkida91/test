name: Actualizar DuckDNS

on:
  push:
    branches:
      - main
    paths:
      - 'CNAME'
  workflow_dispatch: # Permite ejecutar manualmente
  schedule:
    # Actualizar DuckDNS cada 30 minutos para mantenerlo activo
    - cron: '*/30 * * * *'

permissions:
  contents: read

jobs:
  actualizar-duckdns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Verificar CNAME
        id: cname
        run: |
          if [ -f "CNAME" ]; then
            CNAME_DOMAIN=$(cat CNAME | tr -d '\n\r ' | head -1)
            echo "domain=$CNAME_DOMAIN" >> $GITHUB_OUTPUT
            echo "‚úÖ CNAME encontrado: $CNAME_DOMAIN"
          else
            echo "‚ö†Ô∏è  No se encontr√≥ archivo CNAME"
            echo "domain=" >> $GITHUB_OUTPUT
          fi
      
      - name: Actualizar DuckDNS
        if: steps.cname.outputs.domain != ''
        env:
          DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}
          DUCKDNS_DOMAIN: ${{ steps.cname.outputs.domain }}
          DUCKDNS_IP: ${{ secrets.DUCKDNS_IP || '185.199.108.153' }}
        run: |
          # Extraer el nombre del dominio sin .duckdns.org
          # Para subdominios: test.gkachele.duckdns.org ‚Üí solo actualizar gkachele (dominio base)
          # DuckDNS maneja autom√°ticamente los subdominios cuando actualizas el dominio base
          FULL_DOMAIN=$(echo "$DUCKDNS_DOMAIN" | sed 's/\.duckdns\.org$//')
          
          # Si tiene subdominio (ej: test.gkachele), extraer solo el dominio base (gkachele)
          if echo "$FULL_DOMAIN" | grep -q '\.'; then
            # Tiene subdominio: extraer solo el dominio base (√∫ltima parte despu√©s del √∫ltimo punto)
            DOMAIN_NAME=$(echo "$FULL_DOMAIN" | awk -F'.' '{print $NF}')
            SUBDOMAIN=$(echo "$FULL_DOMAIN" | sed "s/\.${DOMAIN_NAME}$//")
            echo "   ‚ÑπÔ∏è  Subdominio detectado: $SUBDOMAIN.$DOMAIN_NAME"
            echo "   ‚ÑπÔ∏è  Actualizando dominio base: $DOMAIN_NAME (DuckDNS maneja autom√°ticamente los subdominios)"
          else
            # No tiene subdominio: usar el dominio completo
            DOMAIN_NAME="$FULL_DOMAIN"
          fi
          
          if [ -z "$DOMAIN_NAME" ]; then
            echo "‚ùå Error: No se pudo extraer el nombre del dominio"
            exit 1
          fi
          
          echo "üîß Actualizando DuckDNS..."
          echo "   CNAME completo: $DUCKDNS_DOMAIN"
          echo "   Dominio base DuckDNS: $DOMAIN_NAME"
          echo "   IP: $DUCKDNS_IP"
          
          if [ -z "$DUCKDNS_TOKEN" ]; then
            echo "‚ö†Ô∏è  DUCKDNS_TOKEN no configurado en secrets"
            echo "   Configurar en: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   Nombre: DUCKDNS_TOKEN"
            echo "   Valor: Tu token de DuckDNS"
            exit 1
          fi
          
          # Actualizar DuckDNS usando la API
          UPDATE_URL="https://www.duckdns.org/update?domains=$DOMAIN_NAME&token=$DUCKDNS_TOKEN&ip=$DUCKDNS_IP"
          
          echo "üì° Enviando actualizaci√≥n a DuckDNS..."
          RESPONSE=$(curl -s "$UPDATE_URL")
          
          if [ "$RESPONSE" = "OK" ]; then
            echo "‚úÖ DuckDNS actualizado correctamente"
            echo "   Dominio: $DUCKDNS_DOMAIN"
            echo "   IP: $DUCKDNS_IP"
          else
            echo "‚ùå Error al actualizar DuckDNS"
            echo "   Respuesta: $RESPONSE"
            echo ""
            echo "   Posibles causas:"
            echo "   - Token inv√°lido"
            echo "   - Dominio no existe"
            echo "   - Problema con la API de DuckDNS"
            exit 1
          fi
      
      - name: Verificar estado
        if: steps.cname.outputs.domain != ''
        run: |
          DOMAIN_NAME=$(echo "${{ steps.cname.outputs.domain }}" | sed 's/\.duckdns\.org$//')
          echo "üîç Verificando estado de DuckDNS..."
          
          # Verificar DNS con dig o nslookup
          if command -v dig &> /dev/null; then
            DNS_RESULT=$(dig +short "${{ steps.cname.outputs.domain }}" @8.8.8.8 || echo "")
            if [ -n "$DNS_RESULT" ]; then
              echo "‚úÖ DNS resuelve a: $DNS_RESULT"
            else
              echo "‚ö†Ô∏è  DNS a√∫n no resuelve (puede tardar unos minutos)"
            fi
          else
            echo "‚ÑπÔ∏è  dig no disponible, saltando verificaci√≥n DNS"
          fi

