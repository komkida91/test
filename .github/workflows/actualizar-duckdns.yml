name: Actualizar DuckDNS

on:
  # NOTA: Desactivado push para dominios principales - solo workflow_dispatch manual
  # Los dominios principales NO deben actualizarse autom√°ticamente
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'CNAME'
  workflow_dispatch: # Permite ejecutar manualmente
  # NOTA: Cron eliminado para evitar actualizaciones autom√°ticas que cambian IPs
  # NOTA: Push tambi√©n desactivado para evitar cambios autom√°ticos
  # DuckDNS mantiene las IPs est√°ticas sin necesidad de actualizaciones peri√≥dicas
  # Solo se actualiza manualmente cuando es necesario (workflow_dispatch)

permissions:
  contents: read

jobs:
  actualizar-duckdns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Verificar CNAME
        id: cname
        run: |
          if [ -f "CNAME" ]; then
            CNAME_DOMAIN=$(cat CNAME | tr -d '\n\r ' | head -1)
            echo "domain=$CNAME_DOMAIN" >> $GITHUB_OUTPUT
            echo "‚úÖ CNAME encontrado: $CNAME_DOMAIN"
          else
            echo "‚ö†Ô∏è  No se encontr√≥ archivo CNAME"
            echo "domain=" >> $GITHUB_OUTPUT
          fi
      
      - name: Actualizar DuckDNS
        if: steps.cname.outputs.domain != ''
        env:
          DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}
          DUCKDNS_DOMAIN: ${{ steps.cname.outputs.domain }}
          # IP por defecto: GitHub Pages (185.199.108.153)
          # IP para subdominios de gkachele: Raspberry Pi (213.195.109.201)
          DUCKDNS_IP_DEFAULT: ${{ secrets.DUCKDNS_IP || '185.199.108.153' }}
          DUCKDNS_IP_RASPBERRY: ${{ secrets.DUCKDNS_IP_RASPBERRY || '213.195.109.201' }}
        run: |
          # Extraer el nombre del dominio sin .duckdns.org
          # Para subdominios: test.gkachele.duckdns.org ‚Üí solo actualizar gkachele (dominio base)
          # DuckDNS maneja autom√°ticamente los subdominios cuando actualizas el dominio base
          FULL_DOMAIN=$(echo "$DUCKDNS_DOMAIN" | sed 's/\.duckdns\.org$//')
          
          # Si tiene subdominio (ej: test.gkachele), extraer solo el dominio base (gkachele)
          IS_SUBDOMAIN=false
          if echo "$FULL_DOMAIN" | grep -q '\.'; then
            # Tiene subdominio: extraer solo el dominio base (√∫ltima parte despu√©s del √∫ltimo punto)
            DOMAIN_NAME=$(echo "$FULL_DOMAIN" | awk -F'.' '{print $NF}')
            SUBDOMAIN=$(echo "$FULL_DOMAIN" | sed "s/\.${DOMAIN_NAME}$//")
            IS_SUBDOMAIN=true
            echo "   ‚ÑπÔ∏è  Subdominio detectado: $SUBDOMAIN.$DOMAIN_NAME"
            echo "   ‚ÑπÔ∏è  Actualizando dominio base: $DOMAIN_NAME (DuckDNS maneja autom√°ticamente los subdominios)"
          else
            # No tiene subdominio: usar el dominio completo
            DOMAIN_NAME="$FULL_DOMAIN"
          fi
          
          if [ -z "$DOMAIN_NAME" ]; then
            echo "‚ùå Error: No se pudo extraer el nombre del dominio"
            exit 1
          fi
          
          # Determinar qu√© IP usar:
          # - Si es subdominio de gkachele (ej: test.gkachele) ‚Üí usar IP de Raspberry Pi
          # - Si es dominio principal (gkachele, blowdance, dalmau-intendente) ‚Üí usar IP de GitHub Pages (185.199.108.153)
          # - IMPORTANTE: gkachele.duckdns.org (sin subdominio) es dominio principal ‚Üí GitHub Pages
          # - DOMINIOS PRINCIPALES DEBEN SER EST√ÅTICOS: gkachele, blowdance, dalmau-intendente ‚Üí SIEMPRE 185.199.108.153
          
          # Lista de dominios principales que DEBEN ser est√°ticos (GitHub Pages)
          MAIN_DOMAINS="gkachele blowdance dalmau-intendente"
          IS_MAIN_DOMAIN=false
          
          for MAIN_DOMAIN in $MAIN_DOMAINS; do
            if [ "$DOMAIN_NAME" = "$MAIN_DOMAIN" ]; then
              IS_MAIN_DOMAIN=true
              break
            fi
          done
          
          if [ "$IS_MAIN_DOMAIN" = "true" ]; then
            # Es un dominio principal ‚Üí SIEMPRE usar IP de GitHub Pages (est√°tica)
            DUCKDNS_IP="185.199.108.153"
            echo "   üîí Dominio principal detectado ($DOMAIN_NAME) ‚Üí IP est√°tica GitHub Pages (185.199.108.153)"
            echo "   ‚ö†Ô∏è  Este dominio DEBE mantener esta IP est√°tica"
          elif [ "$IS_SUBDOMAIN" = "true" ] && [ "$DOMAIN_NAME" = "gkachele" ]; then
            # Es un subdominio de gkachele (ej: test.gkachele.duckdns.org)
            DUCKDNS_IP="$DUCKDNS_IP_RASPBERRY"
            echo "   üçì Subdominio de gkachele detectado ‚Üí usando IP de Raspberry Pi"
          else
            # Otro dominio o subdominio ‚Üí usar IP por defecto (GitHub Pages)
            DUCKDNS_IP="$DUCKDNS_IP_DEFAULT"
            echo "   ‚òÅÔ∏è  Dominio/subdominio ‚Üí usando IP por defecto (GitHub Pages)"
          fi
          
          echo "üîß Actualizando DuckDNS..."
          echo "   CNAME completo: $DUCKDNS_DOMAIN"
          echo "   Dominio base DuckDNS: $DOMAIN_NAME"
          echo "   IP: $DUCKDNS_IP"
          
          if [ -z "$DUCKDNS_TOKEN" ]; then
            echo "‚ö†Ô∏è  DUCKDNS_TOKEN no configurado en secrets"
            echo "   Configurar en: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   Nombre: DUCKDNS_TOKEN"
            echo "   Valor: Tu token de DuckDNS"
            exit 1
          fi
          
          # Verificar IP actual antes de actualizar (evitar cambios innecesarios)
          echo "üîç Verificando IP actual de DuckDNS..."
          CURRENT_IP=$(dig +short "$DUCKDNS_DOMAIN" @8.8.8.8 2>/dev/null | head -n1 || echo "")
          
          if [ -n "$CURRENT_IP" ]; then
            echo "   IP actual: $CURRENT_IP"
            echo "   IP objetivo: $DUCKDNS_IP"
            
            if [ "$CURRENT_IP" = "$DUCKDNS_IP" ]; then
              echo "‚úÖ IP ya es correcta, no se necesita actualizar"
              echo "   IP actual: $CURRENT_IP"
              echo "   IP objetivo: $DUCKDNS_IP"
              exit 0
            else
              if [ "$IS_MAIN_DOMAIN" = "true" ]; then
                echo "‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ATENCI√ìN: Dominio principal con IP incorrecta"
                echo "   Dominio principal: $DOMAIN_NAME"
                echo "   IP actual (incorrecta): $CURRENT_IP"
                echo "   IP objetivo (correcta): $DUCKDNS_IP"
                echo "   üîß Corrigiendo a IP est√°tica de GitHub Pages..."
              else
                echo "‚ö†Ô∏è  IP diferente detectada, actualizando a IP fija..."
              fi
            fi
          else
            if [ "$IS_MAIN_DOMAIN" = "true" ]; then
              echo "‚ö†Ô∏è  No se pudo verificar IP actual, pero es dominio principal ‚Üí actualizando a IP est√°tica..."
            else
              echo "‚ö†Ô∏è  No se pudo verificar IP actual, procediendo con actualizaci√≥n..."
            fi
          fi
          
          # Actualizar DuckDNS usando la API con IP fija
          UPDATE_URL="https://www.duckdns.org/update?domains=$DOMAIN_NAME&token=$DUCKDNS_TOKEN&ip=$DUCKDNS_IP"
          
          echo "üì° Enviando actualizaci√≥n a DuckDNS con IP fija..."
          echo "   URL: https://www.duckdns.org/update?domains=$DOMAIN_NAME&token=***&ip=$DUCKDNS_IP"
          
          # Capturar respuesta y c√≥digo de estado
          RESPONSE=$(curl -s -w "\n%{http_code}" "$UPDATE_URL" 2>&1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "   C√≥digo HTTP: $HTTP_CODE"
          echo "   Respuesta: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" = "200" ] && [ "$RESPONSE_BODY" = "OK" ]; then
            echo "‚úÖ DuckDNS actualizado correctamente con IP fija"
            echo "   Dominio base: $DOMAIN_NAME"
            echo "   Subdominio: $DUCKDNS_DOMAIN"
            echo "   IP fija configurada: $DUCKDNS_IP"
            
            # Verificar que la actualizaci√≥n se aplic√≥
            sleep 5
            VERIFY_IP=$(dig +short "$DUCKDNS_DOMAIN" @8.8.8.8 2>/dev/null | head -n1 || echo "")
            if [ "$VERIFY_IP" = "$DUCKDNS_IP" ]; then
              echo "‚úÖ Verificaci√≥n: IP actualizada correctamente a $DUCKDNS_IP"
            else
              echo "‚ö†Ô∏è  Verificaci√≥n: IP a√∫n no se ha propagado (puede tardar unos minutos)"
              echo "   IP esperada: $DUCKDNS_IP"
              echo "   IP actual: $VERIFY_IP"
            fi
          else
            echo "‚ùå Error al actualizar DuckDNS"
            echo "   C√≥digo HTTP: $HTTP_CODE"
            echo "   Respuesta: $RESPONSE_BODY"
            echo ""
            echo "   Posibles causas:"
            echo "   - Token inv√°lido"
            echo "   - Dominio no existe en DuckDNS"
            echo "   - Problema con la API de DuckDNS"
            echo "   - Problema de red"
            exit 1
          fi
      
      - name: Verificar estado
        if: steps.cname.outputs.domain != ''
        run: |
          DOMAIN_NAME=$(echo "${{ steps.cname.outputs.domain }}" | sed 's/\.duckdns\.org$//')
          echo "üîç Verificando estado de DuckDNS..."
          
          # Verificar DNS con dig o nslookup
          if command -v dig &> /dev/null; then
            DNS_RESULT=$(dig +short "${{ steps.cname.outputs.domain }}" @8.8.8.8 || echo "")
            if [ -n "$DNS_RESULT" ]; then
              echo "‚úÖ DNS resuelve a: $DNS_RESULT"
            else
              echo "‚ö†Ô∏è  DNS a√∫n no resuelve (puede tardar unos minutos)"
            fi
          else
            echo "‚ÑπÔ∏è  dig no disponible, saltando verificaci√≥n DNS"
          fi

