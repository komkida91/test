name: Actualizar DuckDNS

on:
  push:
    branches:
      - main
    paths:
      - 'CNAME'
  workflow_dispatch: # Permite ejecutar manualmente
  schedule:
    # Actualizar DuckDNS cada 30 minutos para mantenerlo activo
    - cron: '*/30 * * * *'

permissions:
  contents: read

jobs:
  actualizar-duckdns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Verificar CNAME
        id: cname
        run: |
          if [ -f "CNAME" ]; then
            CNAME_DOMAIN=$(cat CNAME | tr -d '\n\r ' | head -1)
            echo "domain=$CNAME_DOMAIN" >> $GITHUB_OUTPUT
            echo "‚úÖ CNAME encontrado: $CNAME_DOMAIN"
          else
            echo "‚ö†Ô∏è  No se encontr√≥ archivo CNAME"
            echo "domain=" >> $GITHUB_OUTPUT
          fi
      
      - name: Actualizar DuckDNS
        if: steps.cname.outputs.domain != ''
        env:
          DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}
          DUCKDNS_DOMAIN: ${{ steps.cname.outputs.domain }}
          # IP por defecto: GitHub Pages (185.199.108.153)
          # IP para subdominios de gkachele: Raspberry Pi (213.195.109.201)
          DUCKDNS_IP_DEFAULT: ${{ secrets.DUCKDNS_IP || '185.199.108.153' }}
          DUCKDNS_IP_RASPBERRY: ${{ secrets.DUCKDNS_IP_RASPBERRY || '213.195.109.201' }}
        run: |
          # Extraer el nombre del dominio sin .duckdns.org
          # Para subdominios: test.gkachele.duckdns.org ‚Üí solo actualizar gkachele (dominio base)
          # DuckDNS maneja autom√°ticamente los subdominios cuando actualizas el dominio base
          FULL_DOMAIN=$(echo "$DUCKDNS_DOMAIN" | sed 's/\.duckdns\.org$//')
          
          # Si tiene subdominio (ej: test.gkachele), extraer solo el dominio base (gkachele)
          IS_SUBDOMAIN=false
          if echo "$FULL_DOMAIN" | grep -q '\.'; then
            # Tiene subdominio: extraer solo el dominio base (√∫ltima parte despu√©s del √∫ltimo punto)
            DOMAIN_NAME=$(echo "$FULL_DOMAIN" | awk -F'.' '{print $NF}')
            SUBDOMAIN=$(echo "$FULL_DOMAIN" | sed "s/\.${DOMAIN_NAME}$//")
            IS_SUBDOMAIN=true
            echo "   ‚ÑπÔ∏è  Subdominio detectado: $SUBDOMAIN.$DOMAIN_NAME"
            echo "   ‚ÑπÔ∏è  Actualizando dominio base: $DOMAIN_NAME (DuckDNS maneja autom√°ticamente los subdominios)"
          else
            # No tiene subdominio: usar el dominio completo
            DOMAIN_NAME="$FULL_DOMAIN"
          fi
          
          if [ -z "$DOMAIN_NAME" ]; then
            echo "‚ùå Error: No se pudo extraer el nombre del dominio"
            exit 1
          fi
          
          # Determinar qu√© IP usar:
          # - Si es subdominio de gkachele (ej: test.gkachele) ‚Üí usar IP de Raspberry Pi
          # - Si es dominio principal (gkachele, blowdance, dalmau-intendente) ‚Üí usar IP de GitHub Pages
          # - IMPORTANTE: gkachele.duckdns.org (sin subdominio) es dominio principal ‚Üí GitHub Pages
          if [ "$IS_SUBDOMAIN" = "true" ] && [ "$DOMAIN_NAME" = "gkachele" ]; then
            # Es un subdominio de gkachele (ej: test.gkachele.duckdns.org)
            DUCKDNS_IP="$DUCKDNS_IP_RASPBERRY"
            echo "   üçì Subdominio de gkachele detectado ‚Üí usando IP de Raspberry Pi"
          else
            # Es un dominio principal (gkachele, blowdance, dalmau-intendente, etc.)
            DUCKDNS_IP="$DUCKDNS_IP_DEFAULT"
            echo "   ‚òÅÔ∏è  Dominio principal ‚Üí usando IP por defecto (GitHub Pages)"
          fi
          
          echo "üîß Actualizando DuckDNS..."
          echo "   CNAME completo: $DUCKDNS_DOMAIN"
          echo "   Dominio base DuckDNS: $DOMAIN_NAME"
          echo "   IP: $DUCKDNS_IP"
          
          if [ -z "$DUCKDNS_TOKEN" ]; then
            echo "‚ö†Ô∏è  DUCKDNS_TOKEN no configurado en secrets"
            echo "   Configurar en: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   Nombre: DUCKDNS_TOKEN"
            echo "   Valor: Tu token de DuckDNS"
            exit 1
          fi
          
          # Actualizar DuckDNS usando la API
          UPDATE_URL="https://www.duckdns.org/update?domains=$DOMAIN_NAME&token=$DUCKDNS_TOKEN&ip=$DUCKDNS_IP"
          
          echo "üì° Enviando actualizaci√≥n a DuckDNS..."
          echo "   URL: https://www.duckdns.org/update?domains=$DOMAIN_NAME&token=***&ip=$DUCKDNS_IP"
          
          # Capturar respuesta y c√≥digo de estado
          RESPONSE=$(curl -s -w "\n%{http_code}" "$UPDATE_URL" 2>&1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "   C√≥digo HTTP: $HTTP_CODE"
          echo "   Respuesta: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" = "200" ] && [ "$RESPONSE_BODY" = "OK" ]; then
            echo "‚úÖ DuckDNS actualizado correctamente"
            echo "   Dominio base: $DOMAIN_NAME"
            echo "   Subdominio: $DUCKDNS_DOMAIN"
            echo "   IP: $DUCKDNS_IP"
          else
            echo "‚ùå Error al actualizar DuckDNS"
            echo "   C√≥digo HTTP: $HTTP_CODE"
            echo "   Respuesta: $RESPONSE_BODY"
            echo ""
            echo "   Posibles causas:"
            echo "   - Token inv√°lido"
            echo "   - Dominio no existe en DuckDNS"
            echo "   - Problema con la API de DuckDNS"
            echo "   - Problema de red"
            exit 1
          fi
      
      - name: Verificar estado
        if: steps.cname.outputs.domain != ''
        run: |
          DOMAIN_NAME=$(echo "${{ steps.cname.outputs.domain }}" | sed 's/\.duckdns\.org$//')
          echo "üîç Verificando estado de DuckDNS..."
          
          # Verificar DNS con dig o nslookup
          if command -v dig &> /dev/null; then
            DNS_RESULT=$(dig +short "${{ steps.cname.outputs.domain }}" @8.8.8.8 || echo "")
            if [ -n "$DNS_RESULT" ]; then
              echo "‚úÖ DNS resuelve a: $DNS_RESULT"
            else
              echo "‚ö†Ô∏è  DNS a√∫n no resuelve (puede tardar unos minutos)"
            fi
          else
            echo "‚ÑπÔ∏è  dig no disponible, saltando verificaci√≥n DNS"
          fi

