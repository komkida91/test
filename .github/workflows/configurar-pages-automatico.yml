name: Configurar GitHub Pages Autom√°ticamente

on:
  push:
    branches:
      - main
    paths:
      - 'CNAME'
      - '.github/workflows/configurar-pages-automatico.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  configurar-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configurar GitHub Pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME="${{ github.repository }}"
          REPO_OWNER=$(echo $REPO_NAME | cut -d'/' -f1)
          REPO_REPO=$(echo $REPO_NAME | cut -d'/' -f2)
          
          echo "üîß Configurando Pages para: $REPO_REPO"
          
          # Leer CNAME del repositorio (como estaba originalmente)
          if [ -f "CNAME" ]; then
            CNAME_DOMAIN=$(cat CNAME | tr -d '\n\r ' | head -1)
            echo "üìÑ CNAME encontrado en repo: $CNAME_DOMAIN"
          else
            echo "‚ö†Ô∏è  No se encontr√≥ archivo CNAME"
            CNAME_DOMAIN=""
          fi
          
          # Paso 1: Verificar si Pages est√° habilitado
          echo "üîç Verificando estado de Pages..."
          PAGES_STATUS=$(gh api "repos/$REPO_OWNER/$REPO_REPO/pages" 2>/dev/null || echo "{}")
          
          # Paso 2: Configurar Pages para usar GitHub Actions SIN CNAME
          echo "üöÄ Configurando Pages para GitHub Actions (sin CNAME)..."
          
          # M√©todo 1: Intentar POST con build_type workflow Y cname vac√≠o
          echo "   üìù M√©todo 1: Intentando crear Pages con GitHub Actions..."
          if gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
            -X POST \
            -f build_type=workflow \
            -f cname='' \
            2>/dev/null; then
            echo "   ‚úÖ Pages creado: build_type=workflow, cname=vac√≠o"
          # M√©todo 2: Intentar PUT con build_type workflow Y cname vac√≠o
          elif gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
            -X PUT \
            -f build_type=workflow \
            -f cname='' \
            2>/dev/null; then
            echo "   ‚úÖ Pages actualizado: build_type=workflow, cname=vac√≠o"
          # M√©todo 3: Si Pages existe pero est√° configurado con branch, cambiar a workflow
          elif echo "$PAGES_STATUS" | grep -q '"build_type"'; then
            echo "   üìù Pages existe con otra configuraci√≥n, cambiando a workflow..."
            # Primero eliminar CNAME si existe
            gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
              -X PUT \
              -f cname='' \
              2>/dev/null || true
            # Luego cambiar build_type a workflow
            gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
              -X PUT \
              -f build_type=workflow \
              -f cname='' \
              2>/dev/null && echo "   ‚úÖ Pages configurado: build_type=workflow, cname=vac√≠o" || echo "   ‚ö†Ô∏è  Error al cambiar configuraci√≥n"
          else
            echo "   ‚ö†Ô∏è  No se pudo configurar Pages autom√°ticamente"
            echo "   üìù Pages debe habilitarse manualmente primero:"
            echo "      https://github.com/$REPO_OWNER/$REPO_REPO/settings/pages"
            echo "      ‚Üí Build and deployment: 'GitHub Actions'"
            echo "      ‚Üí Custom domain: DEJAR VAC√çO"
          fi
          
                 # Paso 3: NO configurar Custom domain en Settings
                 # IMPORTANTE: CNAME en repo + SIN Custom domain en Settings = github.io NO redirige
                 if [ -n "$CNAME_DOMAIN" ]; then
                   echo "üîß Paso 3: Verificando CNAME en repo..."
                   echo "   Dominio desde repo: $CNAME_DOMAIN"
                   echo "   ‚ö†Ô∏è  NO configurar Custom domain en Settings"
                   echo "   Solo CNAME en el repo para que DuckDNS funcione"
                   echo ""
                   echo "   ‚úÖ CNAME en repo: $CNAME_DOMAIN"
                 else
                   echo "   ‚ö†Ô∏è  No hay CNAME en el repo"
                 fi

                 echo ""
                 echo "‚úÖ Configuraci√≥n completada:"
                 echo "   - Build type: workflow (GitHub Actions)"
                 echo "   - Custom domain en Settings: VAC√çO (NO configurado)"
                 if [ -n "$CNAME_DOMAIN" ]; then
                   echo "   - CNAME en repo: $CNAME_DOMAIN"
                   echo ""
                   echo "‚úÖ RESULTADO:"
                   echo "   - DuckDNS funcionar√° (por CNAME en repo)"
                   echo "   - github.io NO redirigir√° (sin Custom domain en Settings)"
                   echo ""
                   echo "üìù Si github.io redirige, eliminar Custom domain manualmente:"
                   echo "   https://github.com/$REPO_OWNER/$REPO_REPO/settings/pages"
                   echo "   ‚Üí Custom domain: Eliminar/Remove"
                   echo "   ‚Üí Save"
                 fi
      
      - name: Verificar configuraci√≥n
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME="${{ github.repository }}"
          REPO_OWNER=$(echo $REPO_NAME | cut -d'/' -f1)
          REPO_REPO=$(echo $REPO_NAME | cut -d'/' -f2)
          
          echo "üîç Verificando configuraci√≥n..."
          gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
            --jq '{build_type, cname, status}'

